<!DOCTYPE html>
<html lang="en" style="height: auto; min-height: 100%;">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>One pulse AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
    </style>
</head>
<body class="bg-gray-950 text-white" style="height: auto; min-height: 100%;">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg"></div>
                    <span class="text-xl font-bold">One pulse AI</span>
                </div>
            </div>
            
            <nav id="sidebarNav" class="flex-1 p-4 space-y-2">
                <a data-action="generate" href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg bg-purple-600 text-white">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                    <span class="font-medium">Generate</span>
                </a>
                <a data-action="gallery" href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition">
                    <i data-lucide="image" class="w-5 h-5"></i>
                    <span class="font-medium">My Gallery</span>
                </a>
                <a data-action="favorites" href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition">
                    <i data-lucide="heart" class="w-5 h-5"></i>
                    <span class="font-medium">Favorites</span>
                </a>
                <a data-action="collections" href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition">
                    <i data-lucide="folder" class="w-5 h-5"></i>
                    <span class="font-medium">Collections</span>
                </a>
                <a data-action="explore" href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    <span class="font-medium">Explore</span>
                </a>
                <a data-action="community" href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="font-medium">Community</span>
                </a>
                <a data-action="pro" href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                    <span class="font-medium">Pro Features</span>
                </a>
            </nav>
            
            <div class="p-4 border-t border-gray-800">
                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-400">Credits</span>
                        <span id="creditsText" class="text-sm font-semibold">250 / 500</span>
                    </div>
                    <div id="creditsBar" class="w-full bg-gray-700 rounded-full h-2">
                        <div id="creditsFill" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" style="width: 50%"></div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop" alt="User" class="w-10 h-10 rounded-full">
                    <div class="flex-1">
                        <div class="text-sm font-medium">John Doe</div>
                        <div class="text-xs text-gray-400">Pro Member</div>
                    </div>
                    <i id="settingsBtn" data-lucide="settings" class="w-5 h-5 text-gray-400 cursor-pointer hover:text-white"></i>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1">
            <!-- Header -->
            <header class="bg-gray-900 border-b border-gray-800 px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1 max-w-2xl">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input id="searchInput" type="text" placeholder="Search styles, artists, or prompts..." class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-12 pr-4 py-3 text-sm focus:outline-none focus:border-purple-500 transition" />
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 ml-6">
                        <button id="notificationsBtn" class="p-2 hover:bg-gray-800 rounded-lg transition relative">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        <button id="historyBtn" class="p-2 hover:bg-gray-800 rounded-lg transition">
                            <i data-lucide="history" class="w-5 h-5"></i>
                        </button>
                        <button id="upgradeBtn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-medium hover:from-purple-700 hover:to-pink-700 transition">
                            Upgrade to Pro
                        </button>
                    </div>
                </div>
            </header>

            <!-- Generation Area -->
            <div class="p-8">
                <div class="max-w-7xl mx-auto">
                    <!-- Prompt Input -->
                    <div id="generateCard" class="bg-gray-900 rounded-2xl p-6 mb-6 border border-gray-800">
                        <label class="block text-sm font-medium mb-3">Describe your image</label>
                        <textarea id="promptInput" rows="4" placeholder="A majestic dragon flying over a mystical mountain landscape at sunset, digital art, highly detailed, 4k..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-purple-500 transition resize-none"></textarea>
                        
                        <!-- File Upload and Mic Controls -->
                        <div class="flex items-center space-x-3 mt-3">
                            <input type="file" id="fileInput" accept="image/*,audio/*,video/*,.pdf,.doc,.docx" class="hidden" multiple>
                            <button id="uploadBtn" class="flex items-center space-x-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm font-medium transition">
                                <i data-lucide="paperclip" class="w-4 h-4"></i>
                                <span>Upload File</span>
                            </button>
                            <button id="micButton" class="flex items-center space-x-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm font-medium transition">
                                <i data-lucide="mic" class="w-4 h-4"></i>
                                <span id="micText">Voice Input</span>
                            </button>
                            <div id="filePreview" class="flex-1 flex items-center space-x-2 text-sm text-gray-400"></div>
                        </div>
                        
                        <!-- Negative Prompt -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-3">Negative Prompt (Optional)</label>
                            <textarea id="negativeInput" rows="2" placeholder="blurry, low quality, distorted, ugly, bad anatomy..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-purple-500 transition resize-none"></textarea>
                        </div>
                        
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center space-x-2">
                                <button id="enhanceBtn" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs font-medium transition">
                                    <i data-lucide="wand-2" class="w-3 h-3 inline mr-1"></i>
                                    Enhance Prompt
                                </button>
                                <button id="addRefBtn" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs font-medium transition">
                                    <i data-lucide="image-plus" class="w-3 h-3 inline mr-1"></i>
                                    Add Reference
                                </button>
                                <button id="randomPromptBtn" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs font-medium transition">
                                    <i data-lucide="shuffle" class="w-3 h-3 inline mr-1"></i>
                                    Random Prompt
                                </button>
                            </div>
                            <button id="generateBtn" class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition flex items-center space-x-2">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                <span>Generate</span>
                            </button>
                        </div>

                        <!-- Generation progress and results area -->
                        <div id="generationProgress" class="mt-4 hidden">
                            <div class="text-xs text-gray-400 mb-2">Generation in progress...</div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="progressFill" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" style="width:0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                        <!-- Aspect Ratio -->
                        <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                            <label class="block text-sm font-medium mb-3">Aspect Ratio</label>
                            <div id="aspectButtons" class="grid grid-cols-3 gap-2">
                                <button data-aspect="1:1" class="aspect-square aspect-btn bg-purple-600 rounded-lg flex items-center justify-center text-xs font-medium hover:bg-purple-700 transition">1:1</button>
                                <button data-aspect="16:9" class="aspect-square aspect-btn bg-gray-800 rounded-lg flex items-center justify-center text-xs font-medium hover:bg-gray-700 transition">16:9</button>
                                <button data-aspect="9:16" class="aspect-square aspect-btn bg-gray-800 rounded-lg flex items-center justify-center text-xs font-medium hover:bg-gray-700 transition">9:16</button>
                                <button data-aspect="4:3" class="aspect-square aspect-btn bg-gray-800 rounded-lg flex items-center justify-center text-xs font-medium hover:bg-gray-700 transition">4:3</button>
                                <button data-aspect="3:4" class="aspect-square aspect-btn bg-gray-800 rounded-lg flex items-center justify-center text-xs font-medium hover:bg-gray-700 transition">3:4</button>
                                <button data-aspect="21:9" class="aspect-square aspect-btn bg-gray-800 rounded-lg flex items-center justify-center text-xs font-medium hover:bg-gray-700 transition">21:9</button>
                            </div>
                        </div>

                        <!-- Model -->
                        <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                            <label class="block text-sm font-medium mb-3">AI Model</label>
                            <select id="modelSelect" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-purple-500 transition">
                                <option>One pulse AI Pro v5</option>
                                <option>Realistic Vision</option>
                                <option>Anime Diffusion</option>
                                <option>Fantasy Art</option>
                                <option>Photorealistic</option>
                                <option>Sketch to Image</option>
                            </select>
                        </div>

                        <!-- Quality -->
                        <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                            <label class="block text-sm font-medium mb-3">Quality</label>
                            <select id="qualitySelect" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-purple-500 transition">
                                <option>Standard (Fast)</option>
                                <option>High Quality</option>
                                <option>Ultra HD</option>
                                <option>4K Resolution</option>
                            </select>
                        </div>

                        <!-- Batch Size -->
                        <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                            <label class="block text-sm font-medium mb-3">Batch Size</label>
                            <select id="batchSelect" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-purple-500 transition">
                                <option value="1">1 Image</option>
                                <option value="2">2 Images</option>
                                <option value="4">4 Images</option>
                                <option value="8">8 Images</option>
                            </select>
                        </div>
                    </div>

                    <!-- Style Presets -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Style Presets</h3>
                            <button id="viewAllStyles" class="text-sm text-purple-400 hover:text-purple-300 font-medium">View All Styles</button>
                        </div>
                        <div id="stylesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <div data-style="Realistic" class="style-preset group cursor-pointer">
                                <div class="aspect-square rounded-xl overflow-hidden mb-2 border-2 border-purple-600">
                                    <img src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=300&h=300&fit=crop" alt="Realistic" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                                </div>
                                <p class="text-sm font-medium text-center">Realistic</p>
                            </div>
                            <div data-style="Anime" class="style-preset group cursor-pointer">
                                <div class="aspect-square rounded-xl overflow-hidden mb-2 border-2 border-transparent hover:border-gray-600 transition">
                                    <img src="https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?w=300&h=300&fit=crop" alt="Anime" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                                </div>
                                <p class="text-sm font-medium text-center">Anime</p>
                            </div>
                            <div data-style="Fantasy" class="style-preset group cursor-pointer">
                                <div class="aspect-square rounded-xl overflow-hidden mb-2 border-2 border-transparent hover:border-gray-600 transition">
                                    <img src="https://images.unsplash.com/photo-1541701494587-cb58502866ab?w=300&h=300&fit=crop" alt="Fantasy" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                                </div>
                                <p class="text-sm font-medium text-center">Fantasy</p>
                            </div>
                            <div data-style="3D Render" class="style-preset group cursor-pointer">
                                <div class="aspect-square rounded-xl overflow-hidden mb-2 border-2 border-transparent hover:border-gray-600 transition">
                                    <img src="https://images.unsplash.com/photo-1634017839464-5c339ebe3cb4?w=300&h=300&fit=crop" alt="3D Render" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                                </div>
                                <p class="text-sm font-medium text-center">3D Render</p>
                            </div>
                            <div data-style="Oil Painting" class="style-preset group cursor-pointer">
                                <div class="aspect-square rounded-xl overflow-hidden mb-2 border-2 border-transparent hover:border-gray-600 transition">
                                    <img src="https://images.unsplash.com/photo-1549887534-1541e9326642?w=300&h=300&fit=crop" alt="Oil Painting" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                                </div>
                                <p class="text-sm font-medium text-center">Oil Painting</p>
                            </div>
                            <div data-style="Cyberpunk" class="style-preset group cursor-pointer">
                                <div class="aspect-square rounded-xl overflow-hidden mb-2 border-2 border-transparent hover:border-gray-600 transition">
                                    <img src="https://images.unsplash.com/photo-1561214115-f2f134cc4912?w=300&h=300&fit=crop" alt="Cyberpunk" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                                </div>
                                <p class="text-sm font-medium text-center">Cyberpunk</p>
                            </div>
                        </div>
                    </div>

                    <!-- Image Tools -->
                    <div class="bg-gray-900 rounded-xl p-6 mb-8 border border-gray-800">
                        <h3 class="text-sm font-semibold mb-4">Image Tools</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            <button data-tool="upscale" class="tool-btn flex flex-col items-center justify-center p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition">
                                <i data-lucide="maximize" class="w-6 h-6 mb-2 text-purple-400"></i>
                                <span class="text-xs font-medium">Upscale</span>
                            </button>
                            <button data-tool="variations" class="tool-btn flex flex-col items-center justify-center p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition">
                                <i data-lucide="copy" class="w-6 h-6 mb-2 text-purple-400"></i>
                                <span class="text-xs font-medium">Variations</span>
                            </button>
                            <button data-tool="inpaint" class="tool-btn flex flex-col items-center justify-center p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition">
                                <i data-lucide="paintbrush" class="w-6 h-6 mb-2 text-purple-400"></i>
                                <span class="text-xs font-medium">Inpaint</span>
                            </button>
                            <button data-tool="outpaint" class="tool-btn flex flex-col items-center justify-center p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition">
                                <i data-lucide="crop" class="w-6 h-6 mb-2 text-purple-400"></i>
                                <span class="text-xs font-medium">Outpaint</span>
                            </button>
                            <button data-tool="removebg" class="tool-btn flex flex-col items-center justify-center p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition">
                                <i data-lucide="eraser" class="w-6 h-6 mb-2 text-purple-400"></i>
                                <span class="text-xs font-medium">Remove BG</span>
                            </button>
                            <button data-tool="recolor" class="tool-btn flex flex-col items-center justify-center p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition">
                                <i data-lucide="palette" class="w-6 h-6 mb-2 text-purple-400"></i>
                                <span class="text-xs font-medium">Recolor</span>
                            </button>
                        </div>
                    </div>

                    <!-- Recent Generations -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Recent Generations</h3>
                            <div class="flex items-center space-x-3">
                                <button id="gridViewBtn" class="text-sm text-gray-400 hover:text-white font-medium">
                                    <i data-lucide="grid-3x3" class="w-4 h-4 inline"></i>
                                </button>
                                <button id="listViewBtn" class="text-sm text-gray-400 hover:text-white font-medium">
                                    <i data-lucide="list" class="w-4 h-4 inline"></i>
                                </button>
                                <button id="viewAllBtn" class="text-sm text-purple-400 hover:text-purple-300 font-medium">View All</button>
                            </div>
                        </div>
                        <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- dynamically populated -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Generic modal container -->
    <div id="modalRoot"></div>

    <script>
        lucide.createIcons();

        /* -----------------------------
           Application state and utils
           ----------------------------- */
        const state = {
            credits: 250,
            creditsCap: 500,
            gallery: [], // {id, dataUrl, w, h, prompt, tags:[], fav:bool}
            favorites: new Set(),
            selectedAspect: '1:1',
            model: 'One pulse AI Pro v5',
            quality: 'Standard (Fast)',
            batchSize: 1,
            style: null,
            selectedImageId: null, // for tools
            references: [], // file objects or dataurls
        };

        // Persist / load
        const STORAGE_KEY = 'One pulse AI _state_v1';
        function saveState() {
            const st = {
                credits: state.credits,
                gallery: state.gallery,
                favorites: Array.from(state.favorites),
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
            updateCreditsUI();
        }
        function loadState() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                try {
                    const st = JSON.parse(raw);
                    if (st.credits != null) state.credits = st.credits;
                    if (Array.isArray(st.gallery)) state.gallery = st.gallery;
                    if (Array.isArray(st.favorites)) state.favorites = new Set(st.favorites);
                } catch(e) { console.warn('Failed to parse saved state', e); }
            }
        }
        loadState();

        // helpers
        function uid(prefix='i') { return prefix + Math.random().toString(36).slice(2,9); }
        function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

        /* -----------------------------
           UI elements
           ----------------------------- */
        const creditsText = document.getElementById('creditsText');
        const creditsFill = document.getElementById('creditsFill');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const uploadBtn = document.getElementById('uploadBtn');
        const addRefBtn = document.getElementById('addRefBtn');
        const promptInput = document.getElementById('promptInput');
        const negativeInput = document.getElementById('negativeInput');
        const generateBtn = document.getElementById('generateBtn');
        const generationProgress = document.getElementById('generationProgress');
        const progressFill = document.getElementById('progressFill');
        const galleryGrid = document.getElementById('galleryGrid');
        const aspectButtons = document.querySelectorAll('.aspect-btn');
        const modelSelect = document.getElementById('modelSelect');
        const qualitySelect = document.getElementById('qualitySelect');
        const batchSelect = document.getElementById('batchSelect');
        const stylesGrid = document.getElementById('stylesGrid');
        const enhanceBtn = document.getElementById('enhanceBtn');
        const randomPromptBtn = document.getElementById('randomPromptBtn');
        const micButton = document.getElementById('micButton');
        const micText = document.getElementById('micText');
        const searchInput = document.getElementById('searchInput');
        const viewAllBtn = document.getElementById('viewAllBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const modalRoot = document.getElementById('modalRoot');

        /* -----------------------------
           UI initialization & render
           ----------------------------- */
        function updateCreditsUI() {
            creditsText.textContent = `${state.credits} / ${state.creditsCap}`;
            const perc = (state.credits / state.creditsCap) * 100;
            creditsFill.style.width = clamp(perc, 0, 100) + '%';
        }

        function renderGallery(filterText='') {
            galleryGrid.innerHTML = '';
            const items = state.gallery.filter(item => {
                if (!filterText) return true;
                const s = filterText.toLowerCase();
                return (item.prompt && item.prompt.toLowerCase().includes(s)) || (item.tags && item.tags.join(' ').toLowerCase().includes(s));
            }).slice().reverse(); // newest first
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'group relative cursor-pointer';
                div.dataset.id = item.id;
                div.innerHTML = `
                    <div class="aspect-square rounded-xl overflow-hidden bg-gray-800">
                        <img src="${item.dataUrl}" alt="Generated" class="w-full h-full object-cover group-hover:scale-110 transition duration-300">
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition rounded-xl flex items-end p-4">
                        <div class="flex items-center space-x-2 w-full">
                            <button data-action="download" title="Download" class="flex-1 bg-white/20 backdrop-blur-sm rounded-lg py-2 text-xs font-medium hover:bg-white/30 transition">
                                <i data-lucide="download" class="w-3 h-3 inline"></i>
                            </button>
                            <button data-action="favorite" title="Favorite" class="flex-1 bg-white/20 backdrop-blur-sm rounded-lg py-2 text-xs font-medium hover:bg-white/30 transition">
                                <i data-lucide="heart" class="w-3 h-3 inline"></i>
                            </button>
                            <button data-action="share" title="Share" class="flex-1 bg-white/20 backdrop-blur-sm rounded-lg py-2 text-xs font-medium hover:bg-white/30 transition">
                                <i data-lucide="share-2" class="w-3 h-3 inline"></i>
                            </button>
                            <button data-action="more" title="More" class="flex-1 bg-white/20 backdrop-blur-sm rounded-lg py-2 text-xs font-medium hover:bg-white/30 transition">
                                <i data-lucide="more-vertical" class="w-3 h-3 inline"></i>
                            </button>
                        </div>
                    </div>
                    <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm rounded-lg px-2 py-1 text-xs font-medium">
                        ${item.w}x${item.h}
                    </div>
                `;
                // attach event handlers for buttons
                div.querySelectorAll('button[data-action]').forEach(btn => {
                    btn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        const action = btn.dataset.action;
                        const id = item.id;
                        if (action === 'download') downloadImage(id);
                        if (action === 'favorite') toggleFavorite(id, btn);
                        if (action === 'share') shareImage(id);
                        if (action === 'more') openMoreMenu(id, btn);
                    });
                });
                // clicking the tile selects it
                div.addEventListener('click', () => {
                    state.selectedImageId = item.id;
                    openImageViewer(item);
                });
                galleryGrid.appendChild(div);
            });
            lucide.createIcons();
        }

        function openImageViewer(item) {
            // modal with larger preview and quick tools
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-xl p-4 w-[90%] max-w-4xl">
                    <div class="flex items-start justify-between mb-2">
                        <div class="text-lg font-semibold">Preview</div>
                        <div class="flex items-center space-x-2">
                            <button id="viewerDownload" class="px-3 py-1 bg-gray-800 rounded">Download</button>
                            <button id="viewerClose" class="px-3 py-1 bg-gray-800 rounded">Close</button>
                        </div>
                    </div>
                    <div class="bg-black rounded overflow-hidden p-2">
                        <img id="viewerImg" src="${item.dataUrl}" class="w-full h-auto" />
                    </div>
                    <div class="mt-3 text-sm text-gray-400">
                        <div><strong>Prompt:</strong> ${item.prompt || ''}</div>
                        <div class="mt-2"><strong>Tags:</strong> ${(item.tags||[]).join(', ')}</div>
                    </div>
                </div>
            `;
            modalRoot.appendChild(modal);
            modal.querySelector('#viewerClose').addEventListener('click', () => modal.remove());
            modal.querySelector('#viewerDownload').addEventListener('click', () => downloadDataUrl(item.dataUrl, `${item.id}.png`));
        }

        function openMoreMenu(id, anchorBtn) {
            // simple popover menu under the button — for demo we show remove/delete and apply tool
            const menu = document.createElement('div');
            menu.className = 'absolute bg-gray-800 rounded-lg p-2 shadow-lg z-50';
            menu.style.minWidth = '140px';
            menu.innerHTML = `
                <button data-m="applyTool" class="w-full text-left px-3 py-2 hover:bg-gray-700 rounded">Open in Editor</button>
                <button data-m="delete" class="w-full text-left px-3 py-2 hover:bg-red-700 rounded">Delete</button>
            `;
            document.body.appendChild(menu);
            const rect = anchorBtn.getBoundingClientRect();
            menu.style.left = (rect.left - 10) + 'px';
            menu.style.top = (rect.bottom + 6) + 'px';
            menu.querySelector('[data-m="applyTool"]').addEventListener('click', () => {
                menu.remove();
                openEditorFor(state.gallery.find(g=>g.id===id));
            });
            menu.querySelector('[data-m="delete"]').addEventListener('click', () => {
                menu.remove();
                state.gallery = state.gallery.filter(g => g.id !== id);
                state.favorites.delete(id);
                saveState();
                renderGallery(searchInput.value);
            });
            const onDocClick = (ev) => { if (!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('click', onDocClick); } };
            document.addEventListener('click', onDocClick);
        }

        function toggleFavorite(id, btn) {
            if (state.favorites.has(id)) state.favorites.delete(id);
            else state.favorites.add(id);
            saveState();
            // quick visual toggle (fill color)
            btn.querySelector('svg').style.color = state.favorites.has(id) ? '#ff6b81' : '';
        }

        function downloadImage(id) {
            const item = state.gallery.find(g => g.id === id);
            if (!item) return alert('Image not found');
            downloadDataUrl(item.dataUrl, `${item.id}.png`);
        }

        function downloadDataUrl(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function shareImage(id) {
            const item = state.gallery.find(g => g.id === id);
            if (!item) return;
            // Try Web Share API for files first if supported (not with data URLs). For demo, we can copy data URL to clipboard or open share dialog.
            if (navigator.share) {
                navigator.share({
                    title: 'AI Art',
                    text: item.prompt || '',
                    url: item.dataUrl
                }).catch(()=>{ copyToClipboard(item.dataUrl); alert('Share failed — copied to clipboard instead'); });
            } else {
                copyToClipboard(item.dataUrl);
                alert('Image data URL copied to clipboard (use in chat or save).');
            }
        }

        async function copyToClipboard(text) {
            try { await navigator.clipboard.writeText(text); } catch(e) { console.warn('Clipboard failed', e); }
        }

        /* -----------------------------
           Tools & Editor (basic)
           ----------------------------- */

        function openEditorFor(item) {
            if (!item) return;
            // Build a simple canvas editor where you can paint a mask then apply a blur or color replace
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-xl p-4 w-[95%] max-w-5xl">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-semibold">Editor</div>
                        <div class="flex items-center space-x-2">
                            <button id="saveEdit" class="px-3 py-1 bg-purple-600 rounded">Apply</button>
                            <button id="closeEdit" class="px-3 py-1 bg-gray-800 rounded">Close</button>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <canvas id="editCanvas" style="background:#111; width:100%; height:480px; border-radius:8px;"></canvas>
                        </div>
                        <div class="w-48">
                            <div class="mb-2 text-sm text-gray-400">Brush</div>
                            <input id="brushSize" type="range" min="4" max="80" value="24" class="w-full mb-3" />
                            <div class="mb-2 text-sm text-gray-400">Mode</div>
                            <select id="editMode" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 mb-3">
                                <option value="inpaint">Inpaint (fill masked area)</option>
                                <option value="erase">Erase mask</option>
                                <option value="blur">Blur masked area</option>
                                <option value="colorize">Colorize masked area</option>
                            </select>
                            <input id="colorPicker" type="color" value="#ff66cc" class="w-full mb-3" />
                            <button id="clearMask" class="w-full px-3 py-2 bg-gray-800 rounded mb-2">Clear Mask</button>
                            <button id="applyMask" class="w-full px-3 py-2 bg-purple-600 rounded">Apply Changes</button>
                        </div>
                    </div>
                </div>
            `;
            modalRoot.appendChild(modal);

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = item.dataUrl;
            const canvas = modal.querySelector('#editCanvas');
            const ctx = canvas.getContext('2d');
            const maskCanvas = document.createElement('canvas');
            const maskCtx = maskCanvas.getContext('2d');

            let drawing = false;
            let brushSize = parseInt(modal.querySelector('#brushSize').value, 10);
            let mode = modal.querySelector('#editMode').value;
            let color = modal.querySelector('#colorPicker').value;

            function resizeCanvases() {
                const W = Math.min(window.innerWidth * 0.6, 1000);
                const H = Math.max(360, img.naturalHeight * (W / img.naturalWidth));
                canvas.width = W;
                canvas.height = H;
                maskCanvas.width = W;
                maskCanvas.height = H;
                // draw current image
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                // draw mask overlay
                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.drawImage(maskCanvas, 0, 0);
                ctx.restore();
            }

            img.onload = () => {
                resizeCanvases();
            };
            window.addEventListener('resize', resizeCanvases);

            function drawBrush(x, y) {
                maskCtx.fillStyle = (mode === 'erase') ? 'rgba(0,0,0,0)' : 'rgba(255,255,255,0.9)';
                maskCtx.beginPath();
                maskCtx.arc(x, y, brushSize/2, 0, Math.PI*2);
                maskCtx.fill();
                refresh();
            }

            function refresh() {
                // redraw image then mask overlay
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                // draw mask as red translucent overlay (for editing)
                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.drawImage(maskCanvas,0,0);
                ctx.globalAlpha = 0.3;
                ctx.fillStyle = 'magenta';
                ctx.fillRect(0,0,0,0); // force composite
                ctx.restore();
                // overlay mask visualization
                ctx.save();
                ctx.globalCompositeOperation = 'multiply';
                ctx.drawImage(maskCanvas, 0, 0);
                ctx.restore();
            }

            canvas.addEventListener('pointerdown', (e) => {
                drawing = true;
                const r = canvas.getBoundingClientRect();
                const x = (e.clientX - r.left) * (canvas.width / r.width);
                const y = (e.clientY - r.top) * (canvas.height / r.height);
                drawBrush(x,y);
            });
            canvas.addEventListener('pointermove', (e) => {
                if (!drawing) return;
                const r = canvas.getBoundingClientRect();
                const x = (e.clientX - r.left) * (canvas.width / r.width);
                const y = (e.clientY - r.top) * (canvas.height / r.height);
                drawBrush(x,y);
            });
            window.addEventListener('pointerup', () => drawing = false);

            modal.querySelector('#brushSize').addEventListener('input', (e) => { brushSize = parseInt(e.target.value,10); });
            modal.querySelector('#editMode').addEventListener('change', (e) => mode = e.target.value);
            modal.querySelector('#colorPicker').addEventListener('input', (e) => color = e.target.value);

            modal.querySelector('#clearMask').addEventListener('click', () => {
                maskCtx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
                refresh();
            });

            modal.querySelector('#applyMask').addEventListener('click', () => {
                applyMaskToImage();
            });

            function applyMaskToImage() {
                // Simple demo implementations of operations:
                const temp = document.createElement('canvas');
                temp.width = canvas.width;
                temp.height = canvas.height;
                const tctx = temp.getContext('2d');
                tctx.drawImage(img, 0, 0, temp.width, temp.height);

                // get mask alpha
                const maskData = maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);
                const srcData = tctx.getImageData(0,0,temp.width,temp.height);
                if (mode === 'blur') {
                    // naive blur: for each pixel in mask set to average of neighbors (cheap)
                    const result = tctx.createImageData(srcData.width, srcData.height);
                    const w = srcData.width, h = srcData.height;
                    for (let y=0;y<h;y++){
                        for (let x=0;x<w;x++){
                            const i = (y*w + x)*4;
                            const m = maskData.data[i]; // mask alpha-ish
                            if (m > 120) {
                                // average a small kernel
                                let r=0,g=0,b=0,cnt=0;
                                for (let oy=-1;oy<=1;oy++) for (let ox=-1;ox<=1;ox++){
                                    const nx = clamp(x+ox,0,w-1), ny = clamp(y+oy,0,h-1);
                                    const ni = (ny*w+nx)*4;
                                    r += srcData.data[ni]; g += srcData.data[ni+1]; b += srcData.data[ni+2]; cnt++;
                                }
                                result.data[i] = r/cnt; result.data[i+1] = g/cnt; result.data[i+2] = b/cnt; result.data[i+3] = 255;
                            } else {
                                result.data[i] = srcData.data[i]; result.data[i+1] = srcData.data[i+1]; result.data[i+2] = srcData.data[i+2]; result.data[i+3] = 255;
                            }
                        }
                    }
                    tctx.putImageData(result,0,0);
                } else if (mode === 'colorize') {
                    // fill masked area with color overlay
                    tctx.fillStyle = color;
                    tctx.globalCompositeOperation = 'source-over';
                    // create mask as path by alpha threshold (cheap)
                    const maskImg = maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);
                    const overlay = document.createElement('canvas');
                    overlay.width = maskCanvas.width; overlay.height = maskCanvas.height;
                    const octx = overlay.getContext('2d');
                    // paint mask onto overlay
                    octx.putImageData(maskImg,0,0);
                    octx.globalCompositeOperation = 'source-in';
                    octx.fillStyle = color; octx.fillRect(0,0,overlay.width,overlay.height);
                    tctx.drawImage(overlay, 0, 0);
                } else if (mode === 'inpaint') {
                    // naive: fill masked area with surrounding color (sample border)
                    const w = srcData.width, h = srcData.height;
                    for (let y=0;y<h;y++){
                        for (let x=0;x<w;x++){
                            const i = (y*w + x)*4;
                            const m = maskData.data[i];
                            if (m > 120) {
                                // pick right neighbor until non-masked
                                let found = false;
                                for (let dx=1; dx<10 && !found; dx++){
                                    const nx = clamp(x+dx,0,w-1);
                                    const ni = (y*w + nx)*4;
                                    if (maskData.data[ni] <= 120) {
                                        srcData.data[i] = srcData.data[ni];
                                        srcData.data[i+1] = srcData.data[ni+1];
                                        srcData.data[i+2] = srcData.data[ni+2];
                                        found = true;
                                    }
                                }
                                if (!found) {
                                    // fallback fill
                                    srcData.data[i] = 100; srcData.data[i+1] = 100; srcData.data[i+2] = 100;
                                }
                            }
                        }
                    }
                    tctx.putImageData(srcData,0,0);
                } else {
                    alert('Unsupported edit mode');
                }
                // Export back to data URL and update the image in gallery
                const newDataUrl = temp.toDataURL('image/png');
                // update gallery item
                const idx = state.gallery.findIndex(g => g.id === item.id);
                if (idx >= 0) {
                    state.gallery[idx].dataUrl = newDataUrl;
                    saveState();
                    renderGallery(searchInput.value);
                }
                img.src = newDataUrl;
                // also replace the modal preview
                modal.remove();
            }

            modal.querySelector('#saveEdit').addEventListener('click', () => {
                applyMaskToImage();
            });
            modal.querySelector('#closeEdit').addEventListener('click', () => {
                modal.remove();
            });
        }

        /* -----------------------------
           Image tools (global toolbar handlers)
           ----------------------------- */
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tool = btn.dataset.tool;
                const id = state.selectedImageId || (state.gallery.length ? state.gallery[state.gallery.length-1].id : null);
                if (!id) return alert('No image selected — click an image or generate one first.');
                const item = state.gallery.find(g=>g.id===id);
                if (!item) return alert('Selected image not found');
                if (tool === 'upscale') handleUpscale(item);
                if (tool === 'variations') handleVariations(item);
                if (tool === 'inpaint') openEditorFor(item);
                if (tool === 'outpaint') handleOutpaint(item);
                if (tool === 'removebg') handleRemoveBg(item);
                if (tool === 'recolor') handleRecolor(item);
            });
        });

        function handleUpscale(item) {
            // Simple demo: create a canvas double the resolution and draw image with smoothing
            const img = new Image();
            img.src = item.dataUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth * 2;
                canvas.height = img.naturalHeight * 2;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/png');
                // push to gallery as new item
                const newItem = {
                    id: uid('g'),
                    dataUrl,
                    w: canvas.width,
                    h: canvas.height,
                    prompt: item.prompt + ' (upscaled)',
                    tags: item.tags || []
                };
                state.gallery.push(newItem);
                saveState();
                renderGallery(searchInput.value);
                alert('Upscaled image added to gallery.');
            };
        }

        function handleVariations(item) {
            // Create 3 variations by hue shifting or adding noise
            const count = 3;
            for (let i=0;i<count;i++){
                const img = new Image();
                img.src = item.dataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img,0,0);
                    const idata = ctx.getImageData(0,0,canvas.width,canvas.height);
                    const shift = Math.floor((Math.random()-0.5)*60);
                    for (let p=0;p<idata.data.length;p+=4){
                        // naive hue-ish variation by rotating RGB
                        idata.data[p] = clamp(idata.data[p] + shift, 0, 255);
                        idata.data[p+1] = clamp(idata.data[p+1] - shift/2, 0, 255);
                    }
                    ctx.putImageData(idata,0,0);
                    state.gallery.push({
                        id: uid('g'),
                        dataUrl: canvas.toDataURL('image/png'),
                        w: canvas.width,
                        h: canvas.height,
                        prompt: item.prompt + ' (variation)',
                        tags: item.tags || []
                    });
                    saveState();
                    renderGallery(searchInput.value);
                };
            }
            alert('Variations added to gallery.');
        }

        function handleOutpaint(item) {
            // Demo: extend canvas to the right and fill with gradient + original image
            const img = new Image();
            img.src = item.dataUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = Math.floor(img.naturalWidth * 1.5);
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                // fill background gradient
                const g = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
                g.addColorStop(0,'#111');
                g.addColorStop(1,'#222');
                ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(img, 0, 0);
                const dataUrl = canvas.toDataURL('image/png');
                state.gallery.push({
                    id: uid('g'),
                    dataUrl,
                    w: canvas.width,
                    h: canvas.height,
                    prompt: item.prompt + ' (outpainted)',
                    tags: item.tags || []
                });
                saveState();
                renderGallery(searchInput.value);
                alert('Outpainted image added.');
            };
        }

        function handleRemoveBg(item) {
            // Simple demo algorithm: mark near-white pixels as transparent
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = item.dataUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const idata = ctx.getImageData(0,0,canvas.width,canvas.height);
                for (let i=0;i<idata.data.length;i+=4){
                    const r = idata.data[i], g = idata.data[i+1], b = idata.data[i+2];
                    // if bright/near-white treat as background
                    if ((r > 220 && g > 220 && b > 220) || (Math.abs(r-g)<10 && Math.abs(r-b)<10 && r>200)){
                        idata.data[i+3] = 0;
                    }
                }
                ctx.putImageData(idata,0,0);
                // export as png with transparency
                const dataUrl = canvas.toDataURL('image/png');
                state.gallery.push({
                    id: uid('g'),
                    dataUrl,
                    w: canvas.width,
                    h: canvas.height,
                    prompt: item.prompt + ' (bg removed)',
                    tags: item.tags || []
                });
                saveState();
                renderGallery(searchInput.value);
                alert('Background removal (demo) applied and new image added.');
            };
        }

        function handleRecolor(item) {
            // Apply a CSS-like hue-rotate effect (simple)
            const img = new Image();
            img.src = item.dataUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img,0,0);
                // quick recolor: multiply by tint
                const idata = ctx.getImageData(0,0,canvas.width,canvas.height);
                const tint = [255, 120, 200]; // example tint
                for (let i=0;i<idata.data.length;i+=4){
                    idata.data[i] = (idata.data[i] + tint[0]) / 2;
                    idata.data[i+1] = (idata.data[i+1] + tint[1]) / 2;
                    idata.data[i+2] = (idata.data[i+2] + tint[2]) / 2;
                }
                ctx.putImageData(idata,0,0);
                state.gallery.push({
                    id: uid('g'),
                    dataUrl: canvas.toDataURL('image/png'),
                    w: canvas.width,
                    h: canvas.height,
                    prompt: item.prompt + ' (recolor)',
                    tags: item.tags || []
                });
                saveState();
                renderGallery(searchInput.value);
                alert('Recolor applied (demo).');
            };
        }

        /* -----------------------------
           Prompt helpers & random prompts
           ----------------------------- */
        const randomPrompts = [
            'A cyberpunk city at sunset, neon reflections, ultra-detailed',
            'Portrait of a young woman, oil painting, studio lighting',
            'Majestic dragon flying over a mystical mountain landscape at sunset, digital art',
            'An epic fantasy castle on floating islands, cinematic, vibrant',
            'Futuristic racing car speeding through rainy neon streets, photorealistic'
        ];

        function enhancePrompt() {
            const p = promptInput.value.trim();
            if (!p) return alert('Enter a prompt first.');
            const enhancement = '— highly detailed, cinematic lighting, 4k, photorealistic';
            if (!p.includes('highly detailed')) promptInput.value = p + ' ' + enhancement;
            else alert('Prompt already enhanced.');
        }

        function randomizePrompt() {
            const p = randomPrompts[Math.floor(Math.random()*randomPrompts.length)];
            promptInput.value = p;
        }

        /* -----------------------------
           Generation (mock engine)
           ----------------------------- */
        // Map aspect to pixel dims
        function aspectToSize(aspect, quality) {
            // base 1024 for 1:1 at high quality; scale down for standard
            let base = 1024;
            if (quality.includes('Standard')) base = 640;
            if (quality.includes('Ultra')) base = 1600;
            if (quality.includes('4K')) base = 2048;
            const [a,b] = aspect.split(':').map(Number);
            let w = base, h = Math.round(base * (b/a));
            if (a/b > 1) { w = base; h = Math.round(base * (b/a)); }
            else { h = base; w = Math.round(base * (a/b)); }
            // clamp for demo
            w = clamp(w, 256, 4096);
            h = clamp(h, 256, 4096);
            return {w,h};
        }

        function mockGenerateImage(prompt, width, height, style, seed) {
            // create a canvas with gradient and text overlay to simulate an image
            const canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');

            // background gradient based on seed
            const s = seed || Math.floor(Math.random()*9999);
            const colors = [
                ['#0f172a','#0ea5a2'],
                ['#111827','#7c3aed'],
                ['#1f2937','#ef4444'],
                ['#111827','#06b6d4'],
                ['#0b1220','#ff0066']
            ];
            const c = colors[s % colors.length];
            const g = ctx.createLinearGradient(0,0,width,height);
            g.addColorStop(0, c[0]);
            g.addColorStop(1, c[1]);
            ctx.fillStyle = g; ctx.fillRect(0,0,width,height);

            // subtle noise
            const imageData = ctx.getImageData(0,0,width,height);
            for (let i=0;i<imageData.data.length;i+=4){
                const v = (Math.random()-0.5)*10;
                imageData.data[i] = clamp(imageData.data[i] + v, 0, 255);
                imageData.data[i+1] = clamp(imageData.data[i+1] + v, 0, 255);
                imageData.data[i+2] = clamp(imageData.data[i+2] + v, 0, 255);
            }
            ctx.putImageData(imageData,0,0);

            // draw a simplified subject shape
            ctx.fillStyle = 'rgba(255,255,255,0.08)';
            ctx.beginPath();
            ctx.ellipse(width*0.5, height*0.44, width*0.35, height*0.2, 0, 0, Math.PI*2);
            ctx.fill();

            // prompt text
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            ctx.font = `${Math.max(14, Math.floor(width/32))}px Inter, sans-serif`;
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0,0,0,0.6)';
            ctx.shadowBlur = 8;
            const trimmed = prompt.length > 120 ? prompt.slice(0,120) + '…' : prompt;
            ctx.fillText(trimmed, width/2, height - Math.floor(height/12));

            // small watermark
            ctx.font = `${Math.max(12, Math.floor(width/80))}px Inter, sans-serif`;
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.fillText(`One pulse AI  Demo • ${style || 'default'}`, width - 160, height - 18);

            return canvas.toDataURL('image/png');
        }

        async function generateImages() {
            const prompt = promptInput.value.trim();
            if (!prompt) return alert('Please enter a prompt.');
            const negative = negativeInput.value.trim();
            const model = modelSelect.value;
            const quality = qualitySelect.value;
            const batch = parseInt(batchSelect.value, 10);
            const aspect = state.selectedAspect;
            const {w,h} = aspectToSize(aspect, quality);

            // cost per image based on quality
            const costPerImage = quality.includes('Ultra')||quality.includes('4K') ? 30 : (quality.includes('High') ? 15 : 8);
            const totalCost = costPerImage * batch;
            if (state.credits < totalCost) {
                if (!confirm('Not enough credits for this generation — go to Upgrade?')) return;
                // redirect to upgrade flow (demo)
                alert('Open upgrade modal (demo).');
            }

            // show progress
            generationProgress.classList.remove('hidden');
            progressFill.style.width = '0%';

            // simulate longer work for larger batches / quality
            const totalSteps = batch;
            for (let i=0;i<batch;i++){
                await new Promise(res => setTimeout(res, 600 + Math.random()*900)); // simulate API time

                const dataUrl = mockGenerateImage(prompt + (negative ? ' — negative: ' + negative : ''), w, h, state.style || model, Math.floor(Math.random()*9999));
                const item = {
                    id: uid('g'),
                    dataUrl,
                    w, h,
                    prompt,
                    tags: [state.style || model],
                    fav: false
                };
                state.gallery.push(item);
                state.credits = Math.max(0, state.credits - costPerImage);
                // update progress
                const pct = Math.round(((i+1)/totalSteps)*100);
                progressFill.style.width = pct + '%';
                renderGallery(searchInput.value);
                saveState();
            }
            generationProgress.classList.add('hidden');
            progressFill.style.width = '0%';
            alert('Generation complete! Images added to gallery.');
        }

        /* -----------------------------
           Input handlers & events
           ----------------------------- */
        // upload / references
        uploadBtn.addEventListener('click', () => fileInput.click());
        addRefBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const dataUrl = reader.result;
                        state.references.push({name: file.name, dataUrl});
                        // show preview pill
                        const pill = document.createElement('div');
                        pill.className = 'flex items-center space-x-2 bg-gray-800 rounded-lg px-3 py-2';
                        pill.innerHTML = `
                            <img src="${dataUrl}" class="w-8 h-8 rounded" />
                            <span class="text-sm">${file.name}</span>
                            <button class="ml-2 text-gray-400 hover:text-white remove-ref">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        `;
                        filePreview.appendChild(pill);
                        pill.querySelector('.remove-ref').addEventListener('click', () => { pill.remove(); state.references = state.references.filter(r=>r.name !== file.name); });
                        lucide.createIcons();
                    };
                    reader.readAsDataURL(file);
                } else {
                    // for non-images we just show name
                    const pill = document.createElement('div');
                    pill.className = 'flex items-center space-x-2 bg-gray-800 rounded-lg px-3 py-2';
                    pill.innerHTML = `
                        <i data-lucide="file" class="w-4 h-4 text-purple-400"></i>
                        <span class="text-sm">${file.name}</span>
                        <button class="ml-2 text-gray-400 hover:text-white remove-ref">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    `;
                    filePreview.appendChild(pill);
                    pill.querySelector('.remove-ref').addEventListener('click', () => pill.remove());
                    lucide.createIcons();
                }
            });
            // clear input
            e.target.value = '';
        });

        // generate button
        generateBtn.addEventListener('click', async () => {
            generateBtn.disabled = true;
            await generateImages();
            generateBtn.disabled = false;
        });

        // aspect selection
        aspectButtons.forEach(b => {
            b.addEventListener('click', () => {
                aspectButtons.forEach(x => x.classList.remove('bg-purple-600'));
                b.classList.add('bg-purple-600');
                state.selectedAspect = b.dataset.aspect;
            });
        });

        modelSelect.addEventListener('change', (e) => state.model = e.target.value);
        qualitySelect.addEventListener('change', (e) => state.quality = e.target.value);
        batchSelect.addEventListener('change', (e) => state.batchSize = parseInt(e.target.value,10));

        // style presets
        stylesGrid.querySelectorAll('.style-preset').forEach(p => {
            p.addEventListener('click', () => {
                stylesGrid.querySelectorAll('.style-preset').forEach(x=>x.classList.remove('ring-2','ring-purple-500'));
                p.classList.add('ring-2','ring-purple-500');
                state.style = p.dataset.style;
            });
        });

        enhanceBtn.addEventListener('click', enhancePrompt);
        randomPromptBtn.addEventListener('click', randomizePrompt);

        // search filters
        searchInput.addEventListener('input', (e) => {
            renderGallery(e.target.value);
        });

        // view toggles
        gridViewBtn.addEventListener('click', () => {
            galleryGrid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';
        });
        listViewBtn.addEventListener('click', () => {
            galleryGrid.className = 'grid grid-cols-1 gap-3';
        });

        // navigation (sidebar)
        document.getElementById('sidebarNav').addEventListener('click', (ev) => {
            const a = ev.target.closest('a[data-action]');
            if (!a) return;
            ev.preventDefault();
            document.querySelectorAll('#sidebarNav .nav-item').forEach(n => n.classList.remove('bg-purple-600','text-white'));
            a.classList.add('bg-purple-600','text-white');
            const action = a.dataset.action;
            if (action === 'gallery') {
                // scroll to gallery (demo)
                document.getElementById('galleryGrid').scrollIntoView({behavior:'smooth'});
            } else if (action === 'generate') {
                document.getElementById('generateCard').scrollIntoView({behavior:'smooth'});
            } else {
                alert(`Nav "${action}" clicked (demo)`);
            }
        });

        // settings button
        document.getElementById('settingsBtn').addEventListener('click', () => {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-xl p-6 w-[90%] max-w-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-lg font-semibold">Settings</div>
                        <button id="closeSettings" class="px-3 py-1 bg-gray-800 rounded">Close</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400">Display Name</label>
                            <input id="displayName" class="w-full mt-1 bg-gray-800 border border-gray-700 rounded px-3 py-2" value="John Doe" />
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Membership</label>
                            <div class="mt-1 text-sm">Pro Member</div>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="saveSettings" class="px-4 py-2 bg-purple-600 rounded">Save</button>
                    </div>
                </div>
            `;
            modalRoot.appendChild(modal);
            modal.querySelector('#closeSettings').addEventListener('click', ()=>modal.remove());
            modal.querySelector('#saveSettings').addEventListener('click', ()=>{ alert('Settings saved (demo)'); modal.remove(); });
        });

        // notifications / history / upgrade
        document.getElementById('notificationsBtn').addEventListener('click', ()=> alert('No notifications (demo)'));
        document.getElementById('historyBtn').addEventListener('click', ()=> alert('History (demo)'));
        document.getElementById('upgradeBtn').addEventListener('click', ()=> {
            // demo upgrade: refill credits
            const add = parseInt(prompt('Enter credits to add (demo):', '250')||0,10);
            if (add>0) {
                state.credits = clamp(state.credits + add, 0, state.creditsCap);
                saveState();
                alert('Credits added (demo)');
            }
        });

        // view all styles
        document.getElementById('viewAllStyles').addEventListener('click', ()=> alert('Show full styles list (demo)'));

        // view all gallery
        viewAllBtn.addEventListener('click', ()=> galleryGrid.scrollIntoView({behavior:'smooth'}));

        /* -----------------------------
           Voice input (improved)
           ----------------------------- */
        let recognition = null;
        let isRecording = false;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isRecording = true;
                micButton.classList.add('bg-red-600', 'recording');
                micButton.classList.remove('bg-gray-800');
                micText.textContent = 'Recording...';
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // show interim in placeholder (not persistent) and finalize when finalTranscript exists
                if (interimTranscript) {
                    micButton.setAttribute('title', interimTranscript);
                }
                if (finalTranscript) {
                    promptInput.value += (promptInput.value ? ' ' : '') + finalTranscript.trim();
                }
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopRecording();
            };

            recognition.onend = function() {
                stopRecording();
            };

            micButton.addEventListener('click', function() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });

            function stopRecording() {
                isRecording = false;
                micButton.classList.remove('bg-red-600', 'recording');
                micButton.classList.add('bg-gray-800');
                micText.textContent = 'Voice Input';
            }
        } else {
            micButton.addEventListener('click', function() {
                alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
            });
        }

        /* -----------------------------
           Utilities & startup
           ----------------------------- */
        function init() {
            updateCreditsUI();
            renderGallery();
            lucide.createIcons();
        }
        init();

        // Save state periodically
        setInterval(saveState, 5000);
    </script>
</body>
</html>